<!DOCTYPE html>
<html lang="en">

<head>
  <title>Slot Machine | Online Casino Game</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/main.css">
  <script>
    var slotMachineConfig = {
      //
    }
  </script>
  <script src="assets/js/main.js"></script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <style>
    body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      background-color: #05020f;
    }

    #slot-machine {
      flex: 1 1 auto;
      min-height: 0;
      position: relative;
    }

    /* Blocker to prevent gambling while processing */
    #game-blocker {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 900;
      /* Below modals (1000) but above game */
      display: none;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 2em;
      font-family: sans-serif;
      font-weight: bold;
      backdrop-filter: blur(2px);
    }
  </style>
</head>

<body>
  <div class="game-toolbar">
    <div class="brand">
      <strong>GameZoe Slots</strong>
    </div>
    <div class="wallet-controls">
      <div class="balance-item">
        <span>ğŸ’° é‡‘å¹£: </span>
        <span id="gold-display">è®€å–ä¸­...</span>
        <button onclick="refreshGold()">â†»</button>
      </div>
      <div class="balance-item">
        <span>ğŸ® éŠæˆ²é»æ•¸: </span>
        <span id="game-balance-display">è®€å–ä¸­...</span>
      </div>
      <div class="actions">
        <button class="btn-action" onclick="openDepositModal()">ğŸ“¥ æ›ç¢¼ (å…¥é‡‘)</button>
        <button class="btn-action" onclick="openWithdrawModal()">ğŸ“¤ å‡ºé‡‘ (çµç®—)</button>
      </div>
    </div>
  </div>

  <!-- Deposit Modal -->
  <div id="deposit-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>é‡‘å¹£æ›å–éŠæˆ²é»æ•¸ (æ›ç¢¼)</h3>
      <p>1 é‡‘å¹£ = 1 é»æ•¸</p>
      <p>æ‚¨æœ‰ <span id="modal-gold">0</span> é‡‘å¹£</p>
      <input type="number" id="deposit-amount" placeholder="è¼¸å…¥æ•¸é‡" />
      <div class="modal-buttons">
        <button onclick="confirmDeposit()">ç¢ºèª</button>
        <button onclick="closeModal('deposit-modal')">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdraw-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>éŠæˆ²é»æ•¸å…Œæ›é‡‘å¹£ (å‡ºé‡‘)</h3>
      <p>é»æ•¸é«˜æ–¼ 500 çš„éƒ¨åˆ†æ‰èƒ½æé ˜ã€‚</p>
      <p>å¯æé ˜é‡‘é¡: <span id="max-withdraw">0</span></p>
      <input type="number" id="withdraw-amount" placeholder="è¼¸å…¥æ•¸é‡" />
      <div class="modal-buttons">
        <button onclick="confirmWithdraw()">ç¢ºèª</button>
        <button onclick="closeModal('withdraw-modal')">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <div id="game-blocker">
    <div>ğŸ”’ äº¤æ˜“è™•ç†ä¸­...</div>
  </div>
  <div id="slot-machine"></div>

  <style>
    .game-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #1a1a2e;
      color: white;
      border-bottom: 2px solid #e94560;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    .wallet-controls {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .balance-item {
      background: #16213e;
      padding: 5px 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 1.1em;
    }

    .btn-action {
      background: #e94560;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-action:hover {
      background: #ff5e78;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    .modal-content {
      background: #1a1a2e;
      padding: 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
      border: 1px solid #e94560;
    }

    .modal-content input {
      padding: 8px;
      margin: 10px 0;
      width: 100px;
      color: black;
    }

    .modal-buttons button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>

  <script>
    // --- DATABASE-BACKED BALANCE SYSTEM ---
    const GAME_INTERNAL_KEY = 'smg-balance'; // The key main.js uses
    const userId = new URLSearchParams(window.location.search).get('userId');
    const API_BASE = window.location.origin + '/api/bridge';

    // Track last synced balance to detect changes
    let lastSyncedBalance = 0;
    let dbBalance = 0;  // Balance from database
    let sysGold = 0;    // Platform gold

    console.log("[SlotMachine] Boot. UserID:", userId);

    // 1. INIT: Load balance from DATABASE, not localStorage
    async function initGameSession() {
      if (!userId) {
        console.warn("[SlotMachine] No userId, guest mode");
        localStorage.setItem(GAME_INTERNAL_KEY, 0);
        document.getElementById('game-balance-display').innerText = 'è«‹å…ˆç™»å…¥';
        return;
      }

      try {
        // Fetch balance from database
        const res = await fetch(`${API_BASE}/balance/${userId}`, {
          headers: { 'x-api-key': 'gamezoe-secure-bridge-key' }
        });
        const data = await res.json();

        if (data.success) {
          // gameScore is fish_balance from DB (shared with Fish game)
          dbBalance = Math.floor(data.gameScore || 0);
          sysGold = Math.floor(data.gold || 0);

          // Inject into localStorage for main.js to read
          localStorage.setItem(GAME_INTERNAL_KEY, dbBalance);
          lastSyncedBalance = dbBalance;

          console.log(`[SlotMachine] Loaded from DB: ${dbBalance} points, ${sysGold} gold`);

          // Update UI
          document.getElementById('game-balance-display').innerText = dbBalance.toLocaleString();
          document.getElementById('gold-display').innerText = sysGold.toLocaleString();
        } else {
          console.error("[SlotMachine] API Error:", data);
          // Fallback: use localStorage if exists, otherwise 0
          const localBal = parseFloat(localStorage.getItem(GAME_INTERNAL_KEY) || 0);
          localStorage.setItem(GAME_INTERNAL_KEY, localBal);
        }
      } catch (e) {
        console.error("[SlotMachine] Init failed:", e);
        document.getElementById('game-balance-display').innerText = 'é€£ç·šå¤±æ•—';
      }
    }

    // 2. SYNC: Periodically sync localStorage changes back to database
    async function syncBalanceToDatabase() {
      if (!userId) return;

      const currentBal = parseFloat(localStorage.getItem(GAME_INTERNAL_KEY) || 0);

      // Only sync if balance changed
      if (Math.abs(currentBal - lastSyncedBalance) < 0.01) return;

      const diff = currentBal - lastSyncedBalance;
      console.log(`[SlotMachine] Balance changed: ${lastSyncedBalance} -> ${currentBal} (diff: ${diff})`);

      try {
        // Update fish_balance in database
        const res = await fetch(`/api/slot/sync-balance`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': 'gamezoe-secure-bridge-key'
          },
          body: JSON.stringify({
            userId: userId,
            balance: currentBal
          })
        });

        if (res.ok) {
          lastSyncedBalance = currentBal;
          console.log(`[SlotMachine] Synced to DB: ${currentBal}`);
        }
      } catch (e) {
        console.error("[SlotMachine] Sync failed:", e);
      }
    }

    // 3. UI UPDATE: Update display from localStorage
    function updateBalanceDisplay() {
      const currentBal = parseFloat(localStorage.getItem(GAME_INTERNAL_KEY) || 0);
      document.getElementById('game-balance-display').innerText = Math.floor(currentBal).toLocaleString();

      // Update withdraw modal if open
      const withdrawModal = document.getElementById('withdraw-modal');
      if (withdrawModal && withdrawModal.style.display === 'flex') {
        const max = Math.max(0, Math.floor(currentBal) - 500);
        document.getElementById('max-withdraw').innerText = max.toLocaleString();
      }
    }

    // --- HELPERS ---
    function getGameBalance() {
      return parseFloat(localStorage.getItem(GAME_INTERNAL_KEY) || 0);
    }

    function setGameBalance(amount) {
      localStorage.setItem(GAME_INTERNAL_KEY, amount);
      // Reload to let main.js pick up the new balance
      window.location.reload();
    }

    async function refreshGold() {
      if (!userId) {
        document.getElementById('gold-display').innerText = 'æœªç™»å…¥';
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/balance/${userId}`, {
          headers: { 'x-api-key': 'gamezoe-secure-bridge-key' }
        });
        if (!res.ok) throw new Error("API Error " + res.status);
        const data = await res.json();
        if (data.success) {
          sysGold = Math.floor(data.gold);
          dbBalance = Math.floor(data.gameScore || 0);
          document.getElementById('gold-display').innerText = sysGold.toLocaleString();
          document.getElementById('game-balance-display').innerText = dbBalance.toLocaleString();
        } else {
          document.getElementById('gold-display').innerText = 'éŒ¯èª¤';
        }
      } catch (e) {
        console.error(e);
        document.getElementById('gold-display').innerText = 'é€£ç·šå¤±æ•—';
      }
    }

    // --- MODALS ---
    function openDepositModal() {
      document.getElementById('modal-gold').innerText = sysGold.toLocaleString();
      document.getElementById('deposit-modal').style.display = 'flex';
    }

    function openWithdrawModal() {
      // Sync first to get accurate balance
      syncBalanceToDatabase();
      const bal = getGameBalance();
      const max = Math.max(0, Math.floor(bal) - 500);
      document.getElementById('max-withdraw').innerText = max.toLocaleString();
      document.getElementById('withdraw-modal').style.display = 'flex';
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    // --- DEPOSIT (å…¥é‡‘) ---
    async function confirmDeposit() {
      const amount = parseInt(document.getElementById('deposit-amount').value);
      if (!amount || amount <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡');
      if (amount > sysGold) return alert('é‡‘å¹£ä¸è¶³');

      const btn = event.target;
      const originalText = btn.innerText;
      btn.innerText = "è™•ç†ä¸­...";
      btn.disabled = true;
      document.getElementById('game-blocker').style.display = 'flex';

      // Sync current balance first
      await syncBalanceToDatabase();

      try {
        const res = await fetch(`${API_BASE}/transaction/deposit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': 'gamezoe-secure-bridge-key'
          },
          body: JSON.stringify({
            userId: userId,
            amount: amount,
            gameId: 'slot'
          })
        });
        const data = await res.json();

        if (res.ok && data.success) {
          // Update local balance
          const currentBal = getGameBalance();
          const newBal = currentBal + amount;
          localStorage.setItem(GAME_INTERNAL_KEY, newBal);
          lastSyncedBalance = newBal;

          alert('æ›ç¢¼æˆåŠŸï¼');
          closeModal('deposit-modal');

          // Refresh and reload
          await refreshGold();
          window.location.reload();
        } else {
          alert('æ›ç¢¼å¤±æ•—: ' + (data.message || 'Unknown Error'));
        }
      } catch (e) {
        alert('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        console.error(e);
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
        document.getElementById('game-blocker').style.display = 'none';
      }
    }

    // --- WITHDRAW (å‡ºé‡‘) ---
    async function confirmWithdraw() {
      // Sync first
      await syncBalanceToDatabase();

      const currentBal = getGameBalance();
      const max = Math.max(0, Math.floor(currentBal) - 500);
      const amount = parseInt(document.getElementById('withdraw-amount').value);

      if (!amount || amount <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡');
      if (amount > max) return alert('ç„¡æ³•æé ˜è¶…éå¯è½‰æ›é‡‘é¡: ' + max);

      const btn = event.target;
      const originalText = btn.innerText;
      btn.innerText = "è™•ç†ä¸­...";
      btn.disabled = true;
      document.getElementById('game-blocker').style.display = 'flex';

      // Deduct locally first (optimistic)
      const newBal = currentBal - amount;
      localStorage.setItem(GAME_INTERNAL_KEY, newBal);

      try {
        const res = await fetch(`/api/game/v1/transaction/withdraw`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: userId,
            amount: amount
          })
        });
        const data = await res.json();

        if (res.ok && data.code === 200) {
          lastSyncedBalance = newBal;
          alert('å‡ºé‡‘æˆåŠŸï¼\nå–®è™Ÿ: ' + data.data.order_id);
          closeModal('withdraw-modal');
          await refreshGold();
          window.location.reload();
        } else {
          throw new Error(data.message || 'Unknown Error');
        }
      } catch (e) {
        console.error(e);
        alert('å‡ºé‡‘å¤±æ•—: ' + e.message + '\né»æ•¸å·²é€€å›');

        // Refund locally
        localStorage.setItem(GAME_INTERNAL_KEY, currentBal);
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
        document.getElementById('game-blocker').style.display = 'none';
      }
    }

    // --- LIFECYCLE ---

    // Init on load
    initGameSession();

    // Update UI every 500ms
    setInterval(updateBalanceDisplay, 500);

    // Sync to database every 10 seconds
    setInterval(syncBalanceToDatabase, 10000);

    // Sync on page unload
    window.addEventListener('beforeunload', () => {
      // Use sendBeacon for reliable delivery
      if (userId) {
        const currentBal = parseFloat(localStorage.getItem(GAME_INTERNAL_KEY) || 0);
        navigator.sendBeacon('/api/slot/sync-balance', JSON.stringify({
          userId: userId,
          balance: currentBal
        }));
      }
    });

    // Also sync on visibility change (tab switch)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        syncBalanceToDatabase();
      }
    });
  </script>
</body>

</html>
