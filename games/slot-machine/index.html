<!DOCTYPE html>
<html lang="en">

<head>
  <title>Slot Machine | Online Casino Game</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/main.css">
  <script>
    var slotMachineConfig = {
      //
    }
  </script>
  <!-- CRITICAL: Load balance from DB BEFORE game engine starts -->
  <script>
    // Block game loading until balance is fetched
    window.GAME_BALANCE_READY = false;

    (async function preloadBalance() {
      const GAME_INTERNAL_KEY = 'smg-balance';
      const GAME_ID = 'slot-machine';
      const userId = new URLSearchParams(window.location.search).get('userId');

      if (userId) {
        try {
          const res = await fetch('/api/game-balance/' + userId + '/' + GAME_ID);
          const data = await res.json();
          if (data.success) {
            const balance = Math.floor(data.balance || 0);
            localStorage.setItem(GAME_INTERNAL_KEY, balance);
            console.log('[SlotPreload] Set balance from DB:', balance);
          } else {
            localStorage.setItem(GAME_INTERNAL_KEY, 0);
          }
        } catch (e) {
          console.warn('[SlotPreload] Failed to preload balance:', e);
          localStorage.setItem(GAME_INTERNAL_KEY, 0);
        }
      } else {
        // No user - reset to 0
        localStorage.setItem(GAME_INTERNAL_KEY, 0);
      }

      // Now load the game engine
      window.GAME_BALANCE_READY = true;
      const script = document.createElement('script');
      script.src = 'assets/js/main.js';
      document.head.appendChild(script);
    })();
  </script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <style>
    body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      background-color: #05020f;
    }

    #slot-machine {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <!-- Game container only - balance management handled by platform GamePlayer -->
  <div id="slot-machine"></div>

  <script>
    // --- SIMPLIFIED BALANCE SYNC (UI handled by platform GamePlayer) ---
    const GAME_INTERNAL_KEY = 'smg-balance';
    const GAME_ID = 'slot-machine';
    const userId = new URLSearchParams(window.location.search).get('userId');

    let lastSyncedBalance = 0;

    console.log("[SlotMachine] Boot. UserID:", userId, "GameID:", GAME_ID);

    // Sync localStorage changes back to database
    async function syncBalanceToDatabase() {
      if (!userId) return;

      const currentBal = parseFloat(localStorage.getItem(GAME_INTERNAL_KEY) || 0);
      if (Math.abs(currentBal - lastSyncedBalance) < 0.01) return;

      const consumed = Math.max(0, lastSyncedBalance - currentBal);
      console.log(`[SlotMachine] Sync: ${lastSyncedBalance} -> ${currentBal} (consumed: ${consumed})`);

      try {
        const res = await fetch(`/api/game-balance/sync`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': 'gamezoe-secure-bridge-key'
          },
          body: JSON.stringify({
            userId: userId,
            gameId: GAME_ID,
            newBalance: currentBal,
            consumed: consumed
          })
        });

        if (res.ok) {
          lastSyncedBalance = currentBal;
          console.log(`[SlotMachine] Synced to DB: ${currentBal}`);
        }
      } catch (e) {
        console.error("[SlotMachine] Sync failed:", e);
      }
    }

    // Set initial lastSyncedBalance from localStorage
    lastSyncedBalance = parseFloat(localStorage.getItem(GAME_INTERNAL_KEY) || 0);

    // Sync to database every 5 seconds
    setInterval(syncBalanceToDatabase, 5000);

    // Sync on page unload
    window.addEventListener('beforeunload', () => {
      if (userId) {
        const currentBal = parseFloat(localStorage.getItem(GAME_INTERNAL_KEY) || 0);
        const consumed = Math.max(0, lastSyncedBalance - currentBal);
        navigator.sendBeacon('/api/game-balance/sync', JSON.stringify({
          userId: userId,
          gameId: GAME_ID,
          newBalance: currentBal,
          consumed: consumed
        }));
      }
    });

    // Sync on visibility change (tab switch)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        syncBalanceToDatabase();
      }
    });
  </script>
</body>

</html>
