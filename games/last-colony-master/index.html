<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Last Colony</title>
	<!-- GameZoe Save SDK -->
	<script src="/games/gamezoe-save-sdk.js"></script>
	<script src="js/common.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/game.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/mouse.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/singleplayer.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/maps.js" type="text/javascript" charset="utf-8"></script>

	<!-- Definitions for game entities -->
	<script src="js/buildings.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/vehicles.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/aircraft.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/terrain.js" type="text/javascript" charset="utf-8"></script>

	<!-- A* Implementation by Andrea Giammarchi -->
	<script src="js/astar.js" type="text/javascript" charset="utf-8"></script>

	<script src="js/sidebar.js" type="text/javascript" charset="utf-8"></script>

	<script src="js/bullets.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/fog.js" type="text/javascript" charset="utf-8"></script>

	<script src="js/sounds.js" type="text/javascript" charset="utf-8"></script>

	<script src="js/multiplayer.js" type="text/javascript" charset="utf-8"></script>

	<link rel="stylesheet" href="styles.css" type="text/css" media="screen" charset="utf-8">
</head>

<body>
	<div id="gamecontainer">
		<div id="gamestartscreen" class="gamelayer">
			<span id="singleplayer" onclick="singleplayer.start();">æˆ°å½¹æ¨¡å¼</span>
			<span id="multiplayer" onclick="multiplayer.start();">å¤šäººé€£ç·š</span>
		</div>
		<div id="missionscreen" class="gamelayer">
			<input type="button" id="entermission" onclick="singleplayer.play();">
			<input type="button" id="exitmission" onclick="singleplayer.exit();">
			<div id="missonbriefing">æ­¡è¿ä¾†åˆ°æ‚¨çš„ç¬¬ä¸€å€‹ä»»å‹™ã€‚
			</div>
		</div>
		<div id="gameinterfacescreen" class="gamelayer">
			<div id="gamemessages"></div>
			<div id="callerpicture"></div>
			<div id="cash"></div>
			<div id="sidebarbuttons">
				<input type="button" id="starportbutton" title="æ˜Ÿæ¸¯">
				<input type="button" id="turretbutton" title="ç ²å¡”">
				<input type="button" id="placeholder1" disabled>

				<input type="button" id="scouttankbutton" title="åµå¯Ÿå¦å…‹">
				<input type="button" id="heavytankbutton" title="é‡å‹å¦å…‹">
				<input type="button" id="harvesterbutton" title="æ¡ç¤¦è»Š">

				<input type="button" id="chopperbutton" title="ç›´å‡æ©Ÿ">
				<input type="button" id="wraithbutton" title="å¹½éˆæˆ°æ©Ÿ">
				<input type="button" id="placeholder2" disabled>

			</div>
			<canvas id="gamebackgroundcanvas" height="400" width="480"></canvas>
			<canvas id="gameforegroundcanvas" height="400" width="480"></canvas>
			<input type="text" id="chatmessage"></input>
		</div>

		<div id="messageboxscreen" class="gamelayer">
			<div id="messagebox">
				<span id="messageboxtext"></span>
				<input type="button" id="messageboxok" onclick="game.messageBoxOK();">
				<input type="button" id="messageboxcancel" onclick="game.messageBoxCancel();">
			</div>
		</div>
		<div id="loadingscreen" class="gamelayer">
			<div id="loadingmessage"></div>
		</div>
		<div id="multiplayerlobbyscreen" class="gamelayer">
			<select id="multiplayergameslist" size="10">
			</select>
			<input type="button" id="multiplayerjoin" onclick="multiplayer.join();">
			<input type="button" id="multiplayercancel" onclick="multiplayer.cancel();">
		</div>
	</div>

	<!-- GameZoe å­˜æª”ç³»çµ± -->
	<style>
		.colony-save-prompt {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(0, 30, 60, 0.95);
			border: 3px solid #4488cc;
			padding: 30px;
			z-index: 2000;
			text-align: center;
			display: none;
			color: #88ccff;
		}
		.colony-save-prompt h2 {
			color: #ffcc00;
			margin: 0 0 15px 0;
		}
		.colony-save-prompt p {
			margin-bottom: 20px;
		}
		.colony-save-prompt button {
			margin: 5px;
			padding: 10px 25px;
			background: #336699;
			color: white;
			border: 2px solid #4488cc;
			cursor: pointer;
			font-size: 14px;
		}
		.colony-save-prompt button:hover {
			background: #4488cc;
		}
		.colony-sync-status {
			position: fixed;
			bottom: 10px;
			right: 10px;
			background: rgba(0, 30, 60, 0.9);
			color: #4CAF50;
			padding: 5px 15px;
			border-radius: 5px;
			font-size: 12px;
			display: none;
			z-index: 1000;
		}
	</style>
	<div id="colonySavePrompt" class="colony-save-prompt">
		<h2>ğŸ“‚ ç™¼ç¾é€²åº¦å­˜æª”</h2>
		<p id="colonySaveInfo">å·²å®Œæˆé—œå¡: --</p>
		<button onclick="loadColonySave()">ç¹¼çºŒæˆ°å½¹</button>
		<button onclick="startNewColony()">é‡æ–°é–‹å§‹</button>
	</div>
	<div id="colonySyncStatus" class="colony-sync-status">â˜ï¸ é€²åº¦å·²åŒæ­¥</div>

	<script>
	// ========== GameZoe å­˜æª”ç³»çµ± ==========
	const COLONY_GAME_ID = 'last-colony';
	let colonySaveReady = false;
	let colonySavedLevel = null;

	async function initColonySave() {
		await GameZoeSave.init(COLONY_GAME_ID);
		const cloudSave = await GameZoeSave.load();

		if (cloudSave && cloudSave.currentLevel > 0) {
			colonySavedLevel = cloudSave.currentLevel;
			document.getElementById('colonySaveInfo').innerText =
				`å·²å®Œæˆé—œå¡: ${cloudSave.currentLevel}`;
			console.log('[LastColony] ç™¼ç¾å­˜æª”, é—œå¡:', cloudSave.currentLevel);
		}
		colonySaveReady = true;
	}

	function loadColonySave() {
		document.getElementById('colonySavePrompt').style.display = 'none';
		if (colonySavedLevel !== null && typeof singleplayer !== 'undefined') {
			singleplayer.currentLevel = colonySavedLevel;
			console.log('[LastColony] è¼‰å…¥å­˜æª”, è·³è‡³é—œå¡:', colonySavedLevel);
		}
		colonySavedLevel = null;
	}

	function startNewColony() {
		document.getElementById('colonySavePrompt').style.display = 'none';
		GameZoeSave.delete();
		colonySavedLevel = null;
		console.log('[LastColony] é–‹å§‹æ–°éŠæˆ²');
	}

	async function saveColonyProgress() {
		if (!colonySaveReady || typeof singleplayer === 'undefined') return;

		const saveData = {
			currentLevel: singleplayer.currentLevel,
			timestamp: Date.now()
		};

		await GameZoeSave.save(saveData);

		// é¡¯ç¤ºåŒæ­¥ç‹€æ…‹
		const status = document.getElementById('colonySyncStatus');
		status.style.display = 'block';
		setTimeout(() => { status.style.display = 'none'; }, 1500);
		console.log('[LastColony] é€²åº¦å·²ä¿å­˜:', saveData);
	}

	// æ””æˆª singleplayer.start ä»¥é¡¯ç¤ºå­˜æª”é¸é …
	document.addEventListener('DOMContentLoaded', function() {
		const originalStart = singleplayer.start;
		singleplayer.start = function() {
			if (colonySavedLevel !== null && colonySavedLevel > 0) {
				document.getElementById('colonySavePrompt').style.display = 'block';
				// å»¶é²åŸ·è¡ŒåŸå§‹ startï¼Œè®“ç”¨æˆ¶é¸æ“‡
				window._pendingColonyStart = originalStart;
			} else {
				originalStart.call(singleplayer);
			}
		};

		// åŒ…è£ç¹¼çºŒ/æ–°éŠæˆ²æŒ‰éˆ•çš„è¡Œç‚º
		window.loadColonySave = function() {
			document.getElementById('colonySavePrompt').style.display = 'none';
			if (colonySavedLevel !== null && colonySavedLevel > 0) {
				singleplayer.currentLevel = colonySavedLevel;
			}
			colonySavedLevel = null;
			if (window._pendingColonyStart) {
				// æ‰‹å‹•åŸ·è¡Œ start çš„æ ¸å¿ƒé‚è¼¯
				$('.gamelayer').hide();
				game.type = "singleplayer";
				game.team = "blue";
				singleplayer.startCurrentLevel();
			}
		};

		window.startNewColony = function() {
			document.getElementById('colonySavePrompt').style.display = 'none';
			GameZoeSave.delete();
			colonySavedLevel = null;
			if (window._pendingColonyStart) {
				window._pendingColonyStart.call(singleplayer);
			}
		};
	});

	// ç›£è½é—œå¡è®ŠåŒ–ä¸¦ä¿å­˜
	setInterval(function() {
		if (colonySaveReady && typeof singleplayer !== 'undefined' && singleplayer.currentLevel > 0) {
			saveColonyProgress();
		}
	}, 5000);

	// åˆå§‹åŒ–
	initColonySave();
	</script>
</body>

</html>