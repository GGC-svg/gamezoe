<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <title>Cocos Creator | fish</title>

  <!--http://www.html5rocks.com/en/mobile/mobifying/-->
  <meta name="viewport"
    content="width=device-width,user-scalable=no,initial-scale=1, minimum-scale=1,maximum-scale=1" />

  <!--https://developer.apple.com/library/safari/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html-->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">

  <!-- force webkit on 360 -->
  <meta name="renderer" content="webkit" />
  <meta name="force-rendering" content="webkit" />
  <!-- force edge on IE -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="msapplication-tap-highlight" content="no">

  <!-- force full screen on some browser -->
  <meta name="full-screen" content="yes" />
  <meta name="x5-fullscreen" content="true" />
  <meta name="360-fullscreen" content="true" />

  <!-- force screen orientation on some browser -->
  <meta name="screen-orientation" content="landscape" />
  <meta name="x5-orientation" content="landscape">

  <!--fix fireball/issues/3568 -->
  <!--<meta name="browsermode" content="application">-->
  <meta name="x5-page-mode" content="app">

  <!--<link rel="apple-touch-icon" href=".png" />-->
  <!--<link rel="apple-touch-icon-precomposed" href=".png" />-->

  <link rel="stylesheet" type="text/css" href="style-mobile.css" />

</head>

<body>
  <canvas id="GameCanvas" oncontextmenu="event.preventDefault()" tabindex="0"></canvas>
  <div id="splash">


    <div class="progress-bar stripes">
      <h1><b id="a"></b></h1>
    </div>
  </div>
  <script src="src/settings.js" charset="utf-8"></script>

  <!-- LOGIN DATA SYNC -->
  <script>
    (function () {
      // 1. Get Platform User ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      let platformUserId = urlParams.get('userId');

      // [SECURITY] Require Login - Stop Script Execution if No User
      // Check for both null AND empty string!
      if (!platformUserId || platformUserId.trim() === '') {
        console.error("[LoginSync] No userId in URL. User must login first!");
        console.error("[LoginSync] Received userId:", platformUserId);

        // Show error overlay instead of redirect
        document.body.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#0f172a;color:#fff;font-family:sans-serif;text-align:center;padding:20px;">
            <div>
              <h1 style="font-size:2em;margin-bottom:0.5em;color:#ef4444;">ğŸ”’ æœªç™»å…¥</h1>
              <p style="font-size:1.2em;margin-bottom:1em;color:#94a3b8;">è«‹å…ˆç™»å…¥å¹³å°æ‰èƒ½é€²å…¥éŠæˆ²ï¼</p>
              <p style="color:#64748b;">Please login to the platform before playing.</p>
              <br>
              <button onclick="window.location.href='/'" style="background:#6366f1;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-size:1em;cursor:pointer;font-weight:bold;">
                è¿”å›å¹³å°é¦–é 
              </button>
            </div>
          </div>
        `;
        throw new Error("Login required"); // Stop all script execution
      }

      if (platformUserId) {
        console.log("[LoginSync] Detected Platform User:", platformUserId);

        // 2. Intercept XMLHttpRequest (Cocos usually uses this or fetch)
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function (method, url, async, user, password) {
          // Check if calling Guest/Login endpoint on Game Server
          // URL might be relative "http://localhost:4002/guest" or just "/guest"
          if ((url.includes('/guest') || url.includes('/login')) && !url.includes('account=')) {
            // Append the account param
            const separator = url.includes('?') ? '&' : '?';
            url = url + separator + 'account=' + encodeURIComponent(platformUserId);
            console.log("[LoginSync] redirected XHR:", url);
          }
          return originalOpen.apply(this, arguments);
        };

        // 3. Intercept Fetch (Just in case)
        const originalFetch = window.fetch;
        window.fetch = function (url, options) {
          if (typeof url === 'string' && (url.includes('/guest') || url.includes('/login')) && !url.includes('account=')) {
            const separator = url.includes('?') ? '&' : '?';
            url = url + separator + 'account=' + encodeURIComponent(platformUserId);
            console.log("[LoginSync] redirected Fetch:", url);
          }
          return originalFetch.apply(this, arguments);
        };

        // 5. Deposit (Platform -> Game)
        window.depositToGame = function (amount) {
          console.log("[Wallet] Sending Deposit Request:", amount);
          const userId = platformUserId;
          const body = { userId, amount: parseInt(amount), gameId: 'fish' };

          fetch(BRIDGE_API.DEPOSIT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-api-key': 'gamezoe-secure-bridge-key' },
            body: JSON.stringify(body)
          })
            .then(res => res.json())
            .then(data => {
              console.log("[Wallet] Deposit Response:", data);
              if (data.success) {
                alert("å…Œæ›æˆåŠŸ / Deposit Successful âœ…\nGold deducted, Game Points added.");
                // Refresh Game UI if possible (optional)
              } else {
                alert("å…Œæ›å¤±æ•— / Deposit Failed âŒ\n" + (data.message || "Unknown Error"));
              }
            })
            .catch(err => {
              console.error("[Wallet] Deposit Error:", err);
              alert("ç³»çµ±éŒ¯èª¤ / System Error âš ï¸\nPlease check console.");
            });
        };

        // 6. Withdraw (Game -> Platform)
        // This function is called EXTERNALLY by the Game Client (Cocos)
        window.withdrawFromGame = function (amount) {
          console.log("[Wallet] Sending Withdraw Request:", amount);

          // Ensure we hit the PROXY URL (Relative) to avoid Localhost issues
          // The proxy in server/index.js forwards '/socket.io' but we need a REST endpoint for this?
          // Wait, the Game Server (Mock) has a withdrawal endpoint.

          // Actually, for Withdraw, the GAME calls the BRIDGE directly? 
          // No, usually user clicks a button in Game, Game calls its own backend, backend calls Bridge.
          // If this function is for testing or manual trigger:

          // If we are simulating game-side withdrawal:
          // We need to call the Bridge Withdraw Endpoint directly as if we were the game server?
          // Or call the Game Server's withdraw endpoint?

          // Let's assume this is a client-side helper for testing.
          // It relies on the Game Server being reachable.

          // [FIX] Use Relative URL for Game Server Proxy (if exists) or direct Bridge call?
          // The previous implementation tried to hit `localhost:4002`.
          // We should instead hit the Bridge URL if we want to simulate the result, 
          // OR hit the Game Server via a Proxy if we want the full flow.

          // Since we didn't proxy the REST API of Fish Server (only socket.io), 
          // let's try to hit the Bridge directly to simulate a "Win" settlement?
          // Or if the Game UI calls this, we should alert "Please use Game Menu to Quit/Withdraw".

          alert("Please click 'Exit' in the game to settle points.");
        };
      }
    })();
  </script>

  <style>
    /* Toolbar Styles */
    #wallet-toolbar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: rgba(0, 0, 0, 0.85);
      border-bottom: 2px solid #00d2ff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-sizing: border-box;
      z-index: 9999;
      color: white;
      font-family: "Microsoft JhengHei", sans-serif;
    }

    .wallet-info {
      display: flex;
      gap: 20px;
      font-size: 16px;
    }

    .highlight {
      color: #ffd700;
      font-weight: bold;
    }

    .btn-wallet {
      background: linear-gradient(180deg, #00d2ff 0%, #0078ff 100%);
      border: 1px solid #fff;
      color: white;
      padding: 5px 15px;
      border-radius: 15px;
      cursor: pointer;
      font-weight: bold;
      text-shadow: 1px 1px 1px black;
    }

    .btn-wallet:hover {
      transform: scale(1.05);
    }

    .btn-wallet:active {
      transform: scale(0.95);
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal-box {
      background: #001a33;
      border: 2px solid #00d2ff;
      border-radius: 10px;
      padding: 20px;
      color: white;
      text-align: center;
      font-family: "Microsoft JhengHei", sans-serif;
      box-shadow: 0 0 20px #00d2ff;
    }

    .modal-box input {
      padding: 8px;
      font-size: 16px;
      margin: 10px;
      width: 150px;
      background: #003366;
      border: 1px solid #0078ff;
      color: white;
    }

    .modal-box button {
      margin: 5px;
      padding: 5px 15px;
      cursor: pointer;
    }
  </style>

  <div id="wallet-toolbar">
    <div class="wallet-left">
      <strong>æ•é­šå¤§å¸« Fish Master</strong>
    </div>
    <div class="wallet-info">
      <span>å¹³å°é‡‘å¹£: <span id="ui-gold" class="highlight">è®€å–ä¸­...</span></span>
      <span>éŠæˆ²é»æ•¸: <span id="ui-score" class="highlight">0</span></span>
    </div>
    <div class="wallet-actions">
      <button class="btn-wallet" onclick="Wallet.openDeposit()">ğŸ“¥ æ›ç¢¼(å…¥é‡‘)</button>
      <button class="btn-wallet" onclick="Wallet.openWithdraw()">ğŸ“¤ å‡ºé‡‘(çµç®—)</button>
    </div>
  </div>

  <!-- DEPOSIT MODAL -->
  <div id="modal-deposit" class="modal-overlay">
    <div class="modal-box">
      <h3>å…Œæ›éŠæˆ²é»æ•¸</h3>
      <p>1 é‡‘å¹£ = 1 é»æ•¸</p>
      <p>æ‚¨æœ‰ <span id="modal-gold-av">0</span> é‡‘å¹£</p>
      <input type="number" id="inp-deposit" placeholder="è¼¸å…¥é‡‘å¹£æ•¸é‡">
      <br>
      <button onclick="Wallet.confirmDeposit()" style="background:#0f0;color:#000;">ç¢ºèª</button>
      <button onclick="Wallet.closeModals()" style="background:#f00;color:#fff;">å–æ¶ˆ</button>
    </div>
  </div>

  <!-- WITHDRAW MODAL -->
  <div id="modal-withdraw" class="modal-overlay">
    <div class="modal-box">
      <h3>çµç®—éŠæˆ²é»æ•¸</h3>
      <p>1 é»æ•¸ = 1 é‡‘å¹£</p>
      <p>å¯çµç®—é»æ•¸: <span id="modal-score-av">0</span></p>
      <input type="number" id="inp-withdraw" placeholder="è¼¸å…¥é»æ•¸æ•¸é‡">
      <br>
      <button onclick="Wallet.confirmWithdraw()" style="background:#0f0;color:#000;">ç¢ºèª</button>
      <button onclick="Wallet.closeModals()" style="background:#f00;color:#fff;">å–æ¶ˆ</button>
    </div>
  </div>

  <script>
    window.Wallet = {
      getUserId: function () {
        // 1. URL Param
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('userId')) return urlParams.get('userId');

        // [DEBUG] Fallback for testing display
        console.warn("[Wallet] No userId in URL. Using Test ID: 102746929077306565219");
        return "102746929077306565219";
      },

      sysGold: 0,
      gameScore: 0,

      init: function () {
        this.refresh();
        setInterval(() => this.refresh(), 10000); // [FIX] Increase interval to 10s to stop spam
        // setInterval(() => this.fetchGameScore(), 1000); // [FIX] Disable greedy client polling
      },

      fetchGameScore: function () {
        // Try to read from Cocos
        if (window.cc && window.cc.yqs && window.cc.yqs.userMgr && window.cc.yqs.userMgr.user) {
          this.gameScore = window.cc.yqs.userMgr.user.score; // Is this reliable?
          document.getElementById('ui-score').innerText = Math.floor(this.gameScore).toLocaleString();
        }
      },

      refresh: async function () {
        const uid = this.getUserId();
        if (!uid) return;

        try {
          // FIX: Use Relative URL for Platform API (Works on both 3000/3001/3002)
          const res = await fetch('/api/bridge/balance/' + uid, {
            headers: { 'x-api-key': 'gamezoe-secure-bridge-key' }
          });
          const data = await res.json();
          if (data.success) {
            this.sysGold = data.gold;
            document.getElementById('ui-gold').innerText = Math.floor(data.gold).toLocaleString();

            // Sync Score from API (DB Source of Truth)
            if (data.gameScore !== undefined) {
              this.gameScore = data.gameScore;
              document.getElementById('ui-score').innerText = Math.floor(data.gameScore).toLocaleString();
            }
          }
        } catch (e) { console.error(e); }
      },

      openDeposit: function () {
        this.refresh();
        document.getElementById('modal-gold-av').innerText = this.sysGold;
        document.getElementById('ui-score').innerText = Math.floor(this.gameScore); // Sync
        document.getElementById('modal-deposit').style.display = 'flex';
      },

      openWithdraw: function () {
        this.fetchGameScore(); // Ensure latest
        document.getElementById('modal-score-av').innerText = Math.floor(this.gameScore);
        document.getElementById('modal-withdraw').style.display = 'flex';
      },

      closeModals: function () {
        document.querySelectorAll('.modal-overlay').forEach(e => e.style.display = 'none');
      },

      confirmDeposit: async function () {
        const amount = parseInt(document.getElementById('inp-deposit').value);
        const uid = this.getUserId();
        if (!amount || amount <= 0) return alert("è«‹è¼¸å…¥æ•¸é‡");
        if (!uid) return alert("éŒ¯èª¤: ç„¡æ³•ç¢ºèªç”¨æˆ¶èº«åˆ† (Missing userId)");

        try {
          // 1. Call Platform Bridge API (Deposit)
          // 1. Call Platform Bridge API (Deposit)
          // Relative path works both local and production
          const platformApiUrl = '/api/bridge/transaction/deposit';

          // alert("Debug: Calling " + platformApiUrl);
          console.log("[Wallet] Sending Deposit Request:", { userId: uid, amount: amount, url: platformApiUrl });

          const res = await fetch(platformApiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': 'gamezoe-secure-bridge-key'
            },
            body: JSON.stringify({ userId: uid, amount: amount, gameId: 'fish' })
          });

          const data = await res.json();
          console.log("[Wallet] Deposit Response:", data);

          if (res.ok && data.success) {
            alert("æ›ç¢¼æˆåŠŸ!\nå–®è™Ÿ: " + (data.orderId || "N/A"));
            this.closeModals();
            this.refresh();
            // Poll for game update
            setTimeout(() => this.refresh(), 2000);
          } else {
            // Server might return 'error' OR 'message'
            const errMsg = data.message || data.error || "Unknown Error";
            alert("æ›ç¢¼å¤±æ•—: " + errMsg);
          }
        } catch (e) {
          console.error("[Wallet] Deposit Exception:", e);
          alert("è«‹æ±‚éŒ¯èª¤: " + e.message);
        }
      },

      confirmWithdraw: async function () {
        const amount = parseInt(document.getElementById('inp-withdraw').value);
        const uid = this.getUserId();
        if (!amount || amount <= 0) return alert("è«‹è¼¸å…¥æ•¸é‡");
        if (!uid) return alert("éŒ¯èª¤: ç„¡æ³•ç¢ºèªç”¨æˆ¶èº«åˆ† (Missing userId)");

        try {
          // 1. Get Game Server URL from Cocos Net Module
          let gameApiUrl = "";

          // Debugging connectivity
          console.log("[Wallet] Checking Network:", {
            cc: !!window.cc,
            yqs: window.cc && !!window.cc.yqs,
            net: window.cc && window.cc.yqs && !!window.cc.yqs.net,
            ip: window.cc && window.cc.yqs && window.cc.yqs.net ? window.cc.yqs.net.ip : "N/A"
          });

          if (window.cc && window.cc.yqs && window.cc.yqs.net && window.cc.yqs.net.ip) {
            let baseUrl = window.cc.yqs.net.ip;

            // [FIX] Ensure Protocol
            if (!baseUrl.startsWith('http')) {
              baseUrl = 'http://' + baseUrl;
            }

            // [FIX] PORT CORRECTION
            // If Game Client thinks IP is 'localhost:3000' (because of Proxy), 
            // the API call to /api/game... will 404 on Next.js.
            // Force Game Server Port 9000 if we detect we are targeting Web URL
            if (baseUrl.includes(':3000') || baseUrl === window.location.origin) {
              console.warn("[Wallet] Detected Frontend IP in Game Client. Swapping to Game Port 9000.");
              // Replace port or append port
              // Simplify: Just use current hostname + 9000
              baseUrl = window.location.protocol + "//" + window.location.hostname + ":9000";
            }

            gameApiUrl = baseUrl + '/api/game/v1/transaction/withdraw';
          } else {
            // FALLBACK for Dev/Mock Environment (Force 9000 instead of 4002 to match main Mock Server)
            console.warn("[Wallet] Network IP missing, using localhost:9000 fallback");
            gameApiUrl = 'http://localhost:9000/api/game/v1/transaction/withdraw';

            // Detailed debug alert
            // const debugState = [
            //   "cc: " + (!!window.cc),
            //   "yqs: " + (window.cc && !!window.cc.yqs),
            //   "net: " + (window.cc && window.cc.yqs && !!window.cc.yqs.net),
            //   "ip: " + (window.cc && window.cc.yqs && window.cc.yqs.net ? window.cc.yqs.net.ip : "undefined")
            // ].join(", ");
            // return alert("éŒ¯èª¤: éŠæˆ²æœªé€£ç·šï¼Œç„¡æ³•ç²å–ä¼ºæœå™¨åœ°å€\nDebug: " + debugState);
          }

          console.log("[Wallet] Sending Withdraw Request:", { url: gameApiUrl, body: { user_id: uid, amount: amount } });

          // 2. Call Game Server Withdraw API
          const res = await fetch(gameApiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: uid, amount: amount })
          });

          const data = await res.json();
          console.log("[Wallet] Withdraw Response:", data);

          if (res.ok && data.code === 200) {
            alert("çµç®—æˆåŠŸ!\nå–®è™Ÿ: " + data.data.order_id + "\nå‰©é¤˜é»æ•¸: " + data.data.balance);
            this.closeModals();
            this.refresh();
            // Also try to refresh Platform Balance in iframe if possible (handled by confirmDeposit via refreshing?)
            setTimeout(() => this.refresh(), 2000);
          } else {
            alert("çµç®—å¤±æ•—: " + (data.message || "Unknown Error"));
          }
        } catch (e) {
          console.error("[Wallet] Withdraw Exception:", e);
          alert("è«‹æ±‚éŒ¯èª¤: " + e.message);
        }
      }
    };

    // Start
    setTimeout(() => Wallet.init(), 2000); // Wait for things to load
  </script>

</body>

</html>