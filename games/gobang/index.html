<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=0.9" name="viewport">
  <meta content="DoubleAm的博客,贺雄彪的博客,贺雄彪,鲸落oh,江湖小栈" name="description">
  <meta Content="DoubleAm的博客,贺雄彪的博客,贺雄彪,鲸落oh,江湖小栈" name="keywords">
  <meta content="DoubleAm" name="author">
  <link href="/images/favicon.png" rel="shortcut icon">
  <title>五子棋</title>
  <!-- GameZoe Save SDK -->
  <script src="/games/gamezoe-save-sdk.js"></script>
  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
    }

    .gobang {
      margin: 10px auto;
      width: 642px;
      height: 642px;
      /*border:1px solid;*/
      background: url(picture/bak.jpg);
      overflow: hidden;
    }

    .text {
      margin: 0 auto;
      width: 100px;
      height: 40px;
      text-align: center;
      color: #f00;
      border: 1px solid red;
      line-height: 40px;
      display: block;
    }

    #can {
      margin: 0px auto;
      border: 1px solid green;
      display: block;
    }

    /* 存檔相關樣式 */
    .save-menu {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      z-index: 10000;
      display: none;
    }
    .save-menu h2 {
      color: #fff;
      margin-bottom: 20px;
      font-size: 24px;
    }
    .save-menu button {
      display: block;
      width: 200px;
      margin: 10px auto;
      padding: 15px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
    }
    .save-menu .continue-btn {
      background: #4CAF50;
      color: white;
    }
    .save-menu .new-btn {
      background: #2196F3;
      color: white;
    }
    .save-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: #4CAF50;
      padding: 5px 15px;
      border-radius: 5px;
      font-size: 12px;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
<a href="/" style="position: fixed;top:0;left:0;z-index: 9999;">回到首页</a>
<!-- 存檔選單 -->
<div id="saveMenu" class="save-menu">
  <h2>發現存檔</h2>
  <button class="continue-btn" onclick="loadSavedGame()">繼續遊戲</button>
  <button class="new-btn" onclick="startNewGame()">新遊戲</button>
</div>
<div id="saveStatus" class="save-status">已保存</div>
<canvas class="text">PK</canvas>
<div class="gobang">

  <canvas id="can" width="640" height="640">
    您的浏览器不支持canvas
  </canvas>
</div>
<script>
  // ========== GameZoe 存檔系統 ==========
  const GAME_ID = 'gobang';
  let gameInitialized = false;
  let savedGameData = null;

  // 顯示存檔狀態
  function showSaveStatus() {
    const status = document.getElementById('saveStatus');
    status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 1500);
  }

  // 保存遊戲
  async function saveGame() {
    if (!gameInitialized) return;
    const saveData = {
      maps: maps,
      isBlack: isBlack,
      timestamp: Date.now()
    };
    await GameZoeSave.save(saveData);
    showSaveStatus();
    console.log('[Gobang] 遊戲已保存');
  }

  // 載入已保存的遊戲
  function loadSavedGame() {
    document.getElementById('saveMenu').style.display = 'none';
    if (savedGameData) {
      maps = savedGameData.maps;
      isBlack = savedGameData.isBlack;
      redrawBoard();
      console.log('[Gobang] 已載入存檔');
    }
    gameInitialized = true;
  }

  // 開始新遊戲
  function startNewGame() {
    document.getElementById('saveMenu').style.display = 'none';
    // 清空存檔
    GameZoeSave.delete();
    // 重置棋盤
    for (var i = 0; i < len; i++) {
      for (var j = 0; j < len; j++) {
        maps[i][j] = 0;
      }
    }
    isBlack = true;
    redrawBoard();
    gameInitialized = true;
    console.log('[Gobang] 開始新遊戲');
  }

  // 重新繪製棋盤（用於載入存檔）
  function redrawBoard() {
    // 清空畫布
    ctx.clearRect(0, 0, can.width, can.height);
    // 重繪棋盤格線
    ctx.strokeStyle = "#333";
    for (var m = 0; m < len - 1; m++) {
      for (var n = 0; n < len - 1; n++) {
        ctx.strokeRect(m * 40 + 20, n * 40 + 20, 40, 40);
      }
    }
    // 重繪棋子
    for (var i = 0; i < len; i++) {
      for (var j = 0; j < len; j++) {
        if (maps[i][j] === 2) {
          ctx.drawImage(black, j * 40, i * 40);
        } else if (maps[i][j] === 1) {
          ctx.drawImage(white, j * 40, i * 40);
        }
      }
    }
    // 清空勝利文字
    ctx1.clearRect(0, 0, can1[0].width, can1[0].height);
  }

  // 初始化存檔系統
  async function initSaveSystem() {
    await GameZoeSave.init(GAME_ID);
    savedGameData = await GameZoeSave.load();

    if (savedGameData && savedGameData.maps) {
      // 有存檔，顯示選單
      document.getElementById('saveMenu').style.display = 'block';
    } else {
      // 無存檔，直接開始
      gameInitialized = true;
    }
  }

  // ========== 原有遊戲邏輯 ==========
  var text = document.getElementsByClassName('text');

  //定义二维数组作为棋盘
  var maps = new Array(16);
  var len = maps.length;
  for (var i = 0; i < len; i++) {
    maps[i] = new Array();
    for (var j = 0; j < len; j++) {
      maps[i][j] = 0;
    }
  }

  //初始化棋子
  var black = new Image();
  var white = new Image();
  var clientWidth = document.documentElement.clientWidth;
  black.src = "picture/black.png";
  white.src = "picture/white.png";

  //棋盘初始化
  var can = document.getElementById('can');
  var ctx = can.getContext("2d");
  ctx.strokeStyle = "#333";
  for (var m = 0; m < len - 1; m++) {
    for (var n = 0; n < len - 1; n++) {
      ctx.strokeRect(m * 40 + 20, n * 40 + 20, 40, 40);
    }
  }

  //绘制文字
  var can1 = document.getElementsByClassName('text');
  var ctx1 = can1[0].getContext("2d");
  ctx1.beginPath();
  ctx1.font = ("100px Georgia");
  ctx1.fillStyle = "#F70707";

  var isBlack = true;
  var gameEnded = false;

  //下子
  can.onclick = function play(e) {
    // 遊戲未初始化或已結束則不響應
    if (!gameInitialized || gameEnded) return;

    var l = this.offsetLeft + 20;
    var t = this.offsetTop + 20;
    var x = e.clientX - l;
    var y = e.clientY - t;
    var row, col, index = 0;

    if (x % 40 < 20) {
      col = parseInt(x / 40);
    } else {
      col = parseInt(x / 40) + 1;
    }
    row = y % 40 < 20 ? parseInt(y / 40) : parseInt(y / 40) + 1;

    if (maps[row][col] === 0) {
      if (isBlack) {
        ctx.drawImage(black, col * 40, row * 40);
        isBlack = false;
        maps[row][col] = 2;
        iswin(2, row, col);
      } else {
        ctx.drawImage(white, col * 40, row * 40);
        isBlack = true;
        maps[row][col] = 1;
        iswin(1, row, col);
      }
      // [存檔] 每次落子後保存
      saveGame();
    }

    function iswin(t, row, col) {
      var orgrow, orgcol, total;
      reset();

      while (col > 0 && maps[row][col - 1] == t) {
        total++;
        col--;
      }
      row = orgrow;
      col = orgcol;
      while (col + 1 < 16 && maps[row][col + 1] == t) {
        col++;
        total++;
      }
      celebrate();

      reset();
      while (row > 0 && maps[row - 1][col] == t) {
        total++;
        row--;
      }
      row = orgrow;
      col = orgcol;
      while (row + 1 < 16 && maps[row + 1][col] == t) {
        total++;
        row++;
      }
      celebrate();

      reset();
      while (row > 0 && col > 0 && maps[row - 1][col - 1] == t) {
        row--;
        col--;
        total++;
      }
      row = orgrow;
      col = orgcol;
      while (row + 1 < 16 && col + 1 < 16 && maps[row + 1][col + 1] == t) {
        row++;
        col++;
        total++;
      }
      celebrate();

      reset();
      while (row > 0 && col + 1 < 16 && maps[row - 1][col + 1] == t) {
        row--;
        col++;
        total++;
      }
      row = orgrow;
      col = orgcol;
      while (row + 1 < 16 && col > 0 && maps[row + 1][col - 1] == t) {
        row++;
        col--;
        total++;
      }
      celebrate();

      function celebrate() {
        if (total >= 5) {
          gameEnded = true;
          if (t == 1) {
            ctx1.clearRect(0, 0, can1[0].width, can1[0].height);
            ctx1.fillText("白子赢", 0, 100);
          } else {
            ctx1.clearRect(0, 0, can1[0].width, can1[0].height);
            ctx1.fillText("黑子赢", 0, 100);
          }
          // [存檔] 遊戲結束，清除存檔
          GameZoeSave.delete();
        }
      }

      function reset() {
        orgrow = row;
        orgcol = col;
        total = 1;
      }
    }
  }

  // 頁面載入完成後初始化存檔系統
  window.addEventListener('load', function() {
    // 等待圖片載入完成
    black.onload = function() {
      white.onload = function() {
        initSaveSystem();
      };
      if (white.complete) initSaveSystem();
    };
    if (black.complete && white.complete) {
      initSaveSystem();
    }
  });
</script>

</div>
</body>
</html>