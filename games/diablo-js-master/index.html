<!DOCTYPE html>
<html>

<head>
	<!-- GameZoe Save SDK -->
	<script src="/games/gamezoe-save-sdk.js"></script>
	<style>
		html,
		body,
		canvas {
			margin: 0;
			padding: 0;
			background: black;
			display: block;
			color: rgb(169, 152, 119);
			font-family: Verdana, sans-serif;
			font-size: 13px;
		}

		canvas {
			-webkit-user-select: none;
			-moz-user-select: none;
			-khtml-user-select: none
		}

		a {
			color: #d96500;
		}

		.page {
			margin: 0 auto;
			width: 980px;
		}

		.save-controls {
			position: fixed;
			top: 10px;
			right: 10px;
			z-index: 1000;
		}

		.save-btn {
			background: rgba(100, 65, 0, 0.9);
			color: #ffd700;
			border: 2px solid #8B4513;
			padding: 8px 15px;
			cursor: pointer;
			font-family: inherit;
			font-size: 12px;
			border-radius: 3px;
		}

		.save-btn:hover {
			background: rgba(139, 69, 19, 0.9);
		}

		.save-status {
			position: fixed;
			bottom: 10px;
			right: 10px;
			background: rgba(0, 0, 0, 0.8);
			color: #4CAF50;
			padding: 5px 15px;
			border-radius: 5px;
			font-size: 12px;
			display: none;
			z-index: 1000;
		}

		.load-prompt {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(20, 10, 0, 0.95);
			border: 3px solid #8B4513;
			padding: 30px;
			z-index: 2000;
			text-align: center;
			display: none;
		}

		.load-prompt h2 {
			color: #ffd700;
			margin: 0 0 20px 0;
		}

		.load-prompt p {
			color: #d4a574;
			margin-bottom: 20px;
		}

		.load-prompt button {
			margin: 5px;
			padding: 10px 25px;
			font-size: 14px;
		}
	</style>
</head>

<body>
	<div class="save-controls">
		<button class="save-btn" onclick="saveGame()">ğŸ’¾ ä¿å­˜éŠæˆ²</button>
	</div>
	<div id="saveStatus" class="save-status">âœ“ å·²ä¿å­˜</div>
	<div id="loadPrompt" class="load-prompt">
		<h2>âš”ï¸ ç™¼ç¾å­˜æª”</h2>
		<p id="saveInfo">ç”Ÿå‘½å€¼: -- | ä½ç½®: --</p>
		<button class="save-btn" onclick="loadSavedGame()">ç¹¼çºŒå†’éšª</button>
		<button class="save-btn" onclick="startNewGame()">é‡æ–°é–‹å§‹</button>
	</div>

	<div class="page">
		<canvas id="floor" width="980" height="661"></canvas>
		<p>HTML5 Canvas å’Œ JavaScript è£½ä½œçš„ç­‰è·æ¥µç°¡é¢¨æ ¼éŠæˆ²ã€‚</p>
		<p>See more at <a href="https://github.com/mitallast/diablo-js">github</a></p>
	</div>
	<script>/*window.onerror=alert*/</script>
	<script src="diablo.js"></script>
	<script>
	// ========== GameZoe å­˜æª”ç³»çµ± ==========
	const GAME_ID = 'diablo-js';
	let saveSystemReady = false;
	let pendingSave = null;

	async function initDiabloSave() {
		await GameZoeSave.init(GAME_ID);
		const cloudSave = await GameZoeSave.load();

		if (cloudSave && cloudSave.hero) {
			pendingSave = cloudSave;
			// é¡¯ç¤ºè¼‰å…¥æç¤º
			document.getElementById('saveInfo').innerText =
				`ç”Ÿå‘½å€¼: ${cloudSave.hero.health}/${cloudSave.hero.origin_health}`;
			document.getElementById('loadPrompt').style.display = 'block';
			console.log('[Diablo] ç™¼ç¾å­˜æª”:', cloudSave);
		}
		saveSystemReady = true;
	}

	function loadSavedGame() {
		document.getElementById('loadPrompt').style.display = 'none';
		if (pendingSave && typeof hero !== 'undefined') {
			const save = pendingSave;
			hero.x = save.hero.x || hero.x;
			hero.y = save.hero.y || hero.y;
			hero.health = save.hero.health || hero.health;
			hero.currentDamage = save.hero.currentDamage || hero.currentDamage;
			hero.criticalDamage = save.hero.criticalDamage || hero.criticalDamage;
			// å¾©åŸç‰©å“æ¬„
			if (save.hero.belt && save.hero.belt.items) {
				hero.belt.items = save.hero.belt.items;
			}
			console.log('[Diablo] å­˜æª”å·²è¼‰å…¥');
		}
		pendingSave = null;
	}

	function startNewGame() {
		document.getElementById('loadPrompt').style.display = 'none';
		GameZoeSave.delete();
		pendingSave = null;
		console.log('[Diablo] é–‹å§‹æ–°éŠæˆ²');
	}

	async function saveGame() {
		if (!saveSystemReady || typeof hero === 'undefined') return;

		const saveData = {
			hero: {
				x: hero.x,
				y: hero.y,
				health: hero.health,
				origin_health: hero.origin_health,
				currentDamage: hero.currentDamage,
				criticalDamage: hero.criticalDamage,
				belt: {
					items: hero.belt ? hero.belt.items.map(item => item ? item.constructor.name : null) : [],
					size: hero.belt ? hero.belt.size : 10
				}
			},
			timestamp: Date.now()
		};

		await GameZoeSave.save(saveData);

		// é¡¯ç¤ºä¿å­˜ç‹€æ…‹
		const status = document.getElementById('saveStatus');
		status.style.display = 'block';
		setTimeout(() => { status.style.display = 'none'; }, 1500);
		console.log('[Diablo] éŠæˆ²å·²ä¿å­˜:', saveData);
	}

	// æ¯ 30 ç§’è‡ªå‹•ä¿å­˜
	setInterval(function() {
		if (saveSystemReady && typeof hero !== 'undefined' && hero.health > 0) {
			saveGame();
		}
	}, 30000);

	// é é¢é—œé–‰æ™‚ä¿å­˜
	window.addEventListener('beforeunload', function() {
		if (typeof hero !== 'undefined' && hero.health > 0) {
			saveGame();
		}
	});

	// åˆå§‹åŒ–
	initDiabloSave();
	</script>
</body>

</html>